<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrestling Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #4da6ff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px #0080ff, 0 0 30px #0080ff;
        }
        
        .control-group {
            background: #0f0f0f;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #0080ff;
            box-shadow: 0 0 10px rgba(0, 128, 255, 0.3);
        }
        
        .control-group h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #4da6ff;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #0a0a0a;
            flex: 1;
            min-width: 120px;
            box-shadow: 0 0 20px #00ff88, 0 0 30px rgba(0, 255, 136, 0.5);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #33ffaa, #00ff88);
            box-shadow: 0 0 30px #00ff88, 0 0 40px rgba(0, 255, 136, 0.7);
        }
        
        .btn-secondary {
            background: #1a1a1a;
            color: #4da6ff;
            flex: 1;
            border: 1px solid #0080ff;
        }
        
        .btn-secondary:hover {
            background: #001a33;
            box-shadow: 0 0 10px rgba(0, 128, 255, 0.3);
        }
        
        .btn-secondary.active {
            background: #0080ff;
            color: #0a0a0a;
            box-shadow: 0 0 15px #0080ff, 0 0 25px rgba(0, 128, 255, 0.5);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff3366, #cc0044);
            color: #0a0a0a;
            box-shadow: 0 0 20px #ff3366, 0 0 30px rgba(255, 51, 102, 0.5);
            flex: 1;
            min-width: 120px;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ff6699, #ff3366);
            box-shadow: 0 0 30px #ff3366, 0 0 40px rgba(255, 51, 102, 0.7);
        }
        
        .slider-group {
            margin-bottom: 15px;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #555;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #0080ff;
            cursor: pointer;
            box-shadow: 0 0 15px #0080ff;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #0080ff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 15px #0080ff;
        }
        
        .status {
            background: #0f0f0f;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #0080ff;
            box-shadow: 0 0 15px rgba(0, 128, 255, 0.3);
        }
        
        .status-text {
            font-size: 1.5em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .action-display {
            font-size: 3em;
            font-weight: bold;
            color: #ffffff;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 20px #0080ff, 0 0 30px #0080ff, 0 0 40px #0080ff;
            flex-direction: column;
            gap: 15px;
        }
        
        .next-move {
            font-size: 0.5em;
            color: #ffaa00;
            text-shadow: 0 0 10px #ffaa00;
            margin-bottom: 15px;
        }
        
        .timer {
            font-size: 2em;
            color: #4da6ff;
            text-shadow: 0 0 15px #0080ff;
        }
        
        .custom-timing {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .custom-timing input {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #0080ff;
            border-radius: 5px;
            background: #0a0a0a;
            color: #4da6ff;
            font-family: 'Courier New', monospace;
        }
        
        .system-select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ff9900;
            border-radius: 8px;
            background: #0a0a0a;
            color: #ff9900;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .system-select:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        }
        
        .voice-select {
            flex: 1;
            padding: 8px;
            font-size: 0.95em;
            border: 2px solid #0080ff;
            border-radius: 5px;
            background: #0a0a0a;
            color: #4da6ff;
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }
        
        .voice-select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 128, 255, 0.3);
        }
        
        .system-info {
            font-size: 1em;
            color: #999;
            line-height: 1.6;
        }
        
        .system-info h3 {
            color: #ff9900;
            font-size: 1.1em;
            margin: 10px 0 5px 0;
            text-transform: uppercase;
        }
        
        .system-info ul {
            margin: 5px 0 10px 20px;
            padding: 0;
        }
        
        .system-info li {
            margin: 3px 0;
            font-size: 1em;
        }
        
        .opponent-reaction {
            font-size: 0.65em;
            color: #ffffff;
            text-shadow: 0 0 15px #ff6699, 0 0 25px #ff6699;
            opacity: 0;
            transition: opacity 0.3s;
            margin-top: 7px;
            margin-bottom: 10px;
        }
        
        .opponent-reaction.show {
            opacity: 1;
        }
        
        .opponent-reaction.always-show {
            opacity: 1;
            transition: none;
        }
        
        .volume-lights {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .light {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background: #1a1a1a;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .light.active[data-level="0"] {
            background: #333;
            border-color: #555;
            box-shadow: 0 0 10px #555;
        }
        
        .light.active[data-level="1"] {
            background: #00ff88;
            border-color: #00ff88;
            box-shadow: 0 0 15px #00ff88;
        }
        
        .light.active[data-level="2"] {
            background: #ffaa00;
            border-color: #ffaa00;
            box-shadow: 0 0 15px #ffaa00;
        }
        
        .light.active[data-level="3"] {
            background: #ff3366;
            border-color: #ff3366;
            box-shadow: 0 0 15px #ff3366;
        }
        
        .light.active[data-level="4"] {
            background: #4da6ff;
            border-color: #4da6ff;
            box-shadow: 0 0 15px #4da6ff;
        }
        
        .light.active[data-level="5"],
        .light.active[data-level="6"] {
            background: #ffaa00;
            border-color: #ffaa00;
            box-shadow: 0 0 15px #ffaa00;
        }
        
        .light.active[data-level="7"],
        .light.active[data-level="8"] {
            background: #ff3366;
            border-color: #ff3366;
            box-shadow: 0 0 15px #ff3366;
        }
        
        .light:hover {
            border-color: #0080ff;
        }
        
        .custom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        
        .custom-row span:first-child {
            min-width: 110px;
            color: #999;
        }
        
        .custom-row span:nth-child(3) {
            min-width: 50px;
            text-align: center;
            color: #4da6ff;
            font-weight: 600;
        }
        
        .btn-adjust {
            width: 35px;
            height: 35px;
            padding: 0;
            font-size: 1.3em;
            background: #1a1a1a;
            color: #4da6ff;
            border: 1px solid #0080ff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-adjust:hover {
            background: #001a33;
            box-shadow: 0 0 10px rgba(0, 128, 255, 0.3);
        }
        
        .btn-adjust:active {
            transform: scale(0.95);
        }
        
        .hidden {
            display: none;
        }
        
        /* Mode buttons - two colors */
        [data-mode="random"] {
            background: #1a1a1a !important;
            border-color: #00ff88 !important;
            color: #cccccc !important;
        }
        
        [data-mode="random"].active {
            background: #00ff88 !important;
            color: #0a0a0a !important;
            box-shadow: 0 0 15px #00ff88 !important;
        }
        
        [data-mode="course"] {
            background: #1a1a1a !important;
            border-color: #ff9900 !important;
            color: #cccccc !important;
        }
        
        [data-mode="course"].active {
            background: #ff9900 !important;
            color: #0a0a0a !important;
            box-shadow: 0 0 15px #ff9900 !important;
        }
        
        /* Speed buttons - colored outlines when inactive */
        [data-speed="slow"] {
            background: #1a1a1a !important;
            border: 1px solid #4da6ff !important;
            color: #cccccc !important;
        }
        
        [data-speed="slow"].active {
            background: linear-gradient(135deg, #4da6ff, #0080ff) !important;
            color: #0a0a0a !important;
            border: none !important;
            box-shadow: 0 0 20px #4da6ff !important;
        }
        
        [data-speed="normal"] {
            background: #1a1a1a !important;
            border: 1px solid #00ff88 !important;
            color: #cccccc !important;
        }
        
        [data-speed="normal"].active {
            background: linear-gradient(135deg, #00ff88, #00cc66) !important;
            color: #0a0a0a !important;
            border: none !important;
            box-shadow: 0 0 20px #00ff88 !important;
        }
        
        [data-speed="fast"] {
            background: #1a1a1a !important;
            border: 1px solid #ffaa00 !important;
            color: #cccccc !important;
        }
        
        [data-speed="fast"].active {
            background: linear-gradient(135deg, #ffaa00, #ff6600) !important;
            color: #0a0a0a !important;
            border: none !important;
            box-shadow: 0 0 20px #ffaa00 !important;
        }
        
        [data-speed="chaos"] {
            background: #1a1a1a !important;
            border: 1px solid #ff3366 !important;
            color: #cccccc !important;
        }
        
        [data-speed="chaos"].active {
            background: linear-gradient(135deg, #ff3366, #cc0044) !important;
            color: #0a0a0a !important;
            border: none !important;
            box-shadow: 0 0 20px #ff3366 !important;
        }
        
        /* Timing buttons - cyan outline */
        [data-timing] {
            background: #1a1a1a !important;
            border: 1px solid #00cccc !important;
            color: #cccccc !important;
        }
        
        [data-timing].active {
            background: linear-gradient(135deg, #00ffff, #00cccc) !important;
            color: #0a0a0a !important;
            border: none !important;
            box-shadow: 0 0 20px #00cccc !important;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .control-group {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .control-group h2 {
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            button {
                padding: 12px 15px;
                font-size: 0.9em;
                min-width: 80px;
            }
            
            .action-display {
                font-size: 2em;
                min-height: 60px;
            }
            
            .timer {
                font-size: 1.5em;
            }
            
            .status-text {
                font-size: 1.2em;
            }
            
            .button-group {
                gap: 8px;
            }
            
            .custom-timing {
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
                letter-spacing: 2px;
            }
            
            button {
                padding: 10px 12px;
                font-size: 0.85em;
                letter-spacing: 0.5px;
            }
            
            .action-display {
                font-size: 1.5em;
            }
            
            .timer {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wrestling Trainer</h1>
        
        <div class="status">
            <div class="status-text">Ready</div>
            <div class="action-display" id="actionDisplay">
                <div id="currentMove">—</div>
                <div class="opponent-reaction" id="opponentReaction"></div>
                <div class="next-move" id="nextMove"></div>
            </div>
            <div class="timer" id="timer"></div>
        </div>
        
        <div class="control-group">
            <div class="button-group">
                <button class="btn-primary" id="startBtn">START</button>
                <button class="btn-danger hidden" id="pauseBtn">PAUSE</button>
            </div>
        </div>
        
        <div class="control-group">
            <h2>Mode</h2>
            <div class="button-group">
                <button class="btn-secondary" data-mode="course">Course</button>
                <button class="btn-secondary active" data-mode="random">Random</button>
            </div>
        </div>
        
        <div class="control-group" id="combosGroup">
            <h2>Options</h2>
            <div class="button-group">
                <button class="btn-secondary" id="comboBtn">Combos: OFF</button>
                <button class="btn-secondary" id="showNextBtn">Show Next: OFF</button>
                <button class="btn-secondary" id="showReactionBtnRandom">Show Reaction: OFF</button>
            </div>
        </div>
        
        <div class="control-group hidden" id="courseOptionsGroup">
            <h2>Options</h2>
            <div class="button-group">
                <button class="btn-secondary" id="showNextBtnCourse">Show Next: OFF</button>
                <button class="btn-secondary" id="showReactionBtn">Show Reaction: OFF</button>
            </div>
        </div>
        
        <div class="control-group hidden" id="courseSelector">
            <h2>System</h2>
            <select id="systemSelect" class="system-select">
                <option value="collar_tie">Collar Tie</option>
                <option value="inside_tie">Inside Tie</option>
                <option value="two_on_one">Two-on-One</option>
                <option value="underhook">Underhook</option>
                <option value="overhook_whizzer">Overhook/Whizzer</option>
                <option value="open_no_tie">Open (No Tie)</option>
                <option value="counter_shot">Counter Shot</option>
            </select>
            <div id="systemInfo" class="system-info"></div>
        </div>
        
        <div class="control-group">
            <h2>Speed</h2>
            <div class="button-group">
                <button class="btn-secondary" data-speed="slow">Slow</button>
                <button class="btn-secondary active" data-speed="normal">Normal</button>
                <button class="btn-secondary" data-speed="fast">Fast</button>
                <button class="btn-secondary" data-speed="chaos">Chaos</button>
            </div>
        </div>
        
        <div class="control-group">
            <h2>Volume</h2>
            <div class="volume-lights" id="volumeLights">
                <div class="light" data-level="1"></div>
                <div class="light" data-level="2"></div>
                <div class="light" data-level="3"></div>
                <div class="light" data-level="4"></div>
                <div class="light" data-level="5"></div>
                <div class="light" data-level="6"></div>
                <div class="light" data-level="7"></div>
                <div class="light" data-level="8"></div>
            </div>
        </div>
        
        <div class="control-group">
            <h2>Timing</h2>
            <div class="button-group">
                <button class="btn-secondary active" data-timing="1-20">1min / 20s</button>
                <button class="btn-secondary" data-timing="2-30">2min / 30s</button>
                <button class="btn-secondary" data-timing="5-0">5min Continuous</button>
                <button class="btn-secondary" data-timing="custom">Custom</button>
            </div>
            <div class="custom-timing hidden" id="customTiming">
                <input type="number" id="workTime" placeholder="Work (sec)" value="60">
                <input type="number" id="restTime" placeholder="Rest (sec)" value="20">
            </div>
        </div>
        
        <div class="control-group">
            <h2>Additional Customization</h2>
            <div class="custom-row">
                <span>Voice:</span>
                <select id="voiceSelect" class="voice-select">
                    <option value="0">Default</option>
                </select>
            </div>
            <div class="custom-row">
                <span>Coach Intensity:</span>
                <div class="volume-lights" id="coachLights">
                    <div class="light" data-level="0"></div>
                    <div class="light" data-level="1"></div>
                    <div class="light" data-level="2"></div>
                    <div class="light" data-level="3"></div>
                </div>
            </div>
            <div class="custom-row">
                <span>Speech Speed:</span>
                <div class="volume-lights" id="speechLights">
                    <div class="light" data-level="1"></div>
                    <div class="light" data-level="2"></div>
                    <div class="light" data-level="3"></div>
                    <div class="light" data-level="4"></div>
                </div>
            </div>
            <div class="custom-row">
                <span>Combo Speed:</span>
                <div class="volume-lights" id="comboSpeedLights">
                    <div class="light" data-level="1"></div>
                    <div class="light" data-level="2"></div>
                    <div class="light" data-level="3"></div>
                    <div class="light" data-level="4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load courses data and wrestling moves
        let SYSTEMS = {};
        let BASIC_MOVES = [];
        let COMBOS = [];
        
        Promise.all([
            fetch('courses.json').then(r => r.json()),
            fetch('wrestling_moves.json').then(r => r.json())
        ]).then(([coursesData, movesData]) => {
            SYSTEMS = coursesData.systems.reduce((acc, sys) => {
                acc[sys.system] = sys;
                return acc;
            }, {});
            BASIC_MOVES = movesData.basic_moves;
            COMBOS = movesData.combos;
            updateSystemInfo();
        });
        
        // Action definitions (legacy - kept for compatibility)
        const ACTIONS = {
            easy: ['Circle', 'Sprawl', 'Shoot', 'Down block'],
            medium: ['Move left', 'Move right', 'Forward', 'Backward', 'Circle', 'Fake', 'Fake left', 'Fake right', 'Sprawl', 'Down block'],
            hard: ['Sweep single', 'High crotch', 'Double', 'Left single', 'Right single', 'Left snatch single', 'Right snatch single', 'Circle left', 'Circle right', 'Sprawl', 'Down block', 'Switch left', 'Switch right', 'Reshoot', 'Level change']
        };
        
        // Course sequences - grouped by training focus
        const COURSES = {
            foundations: {
                name: 'Setup & Transition',
                sequences: [
                    ['Fake left', 'Right single'],
                    ['Fake right', 'Left single'],
                    ['Fake left', 'Right single', 'Switch left'],
                    ['Fake right', 'Left single', 'Switch right'],
                    ['Sweep single', 'High crotch'],
                    ['Left single', 'High crotch'],
                    ['Right single', 'High crotch']
                ]
            },
            defense: {
                name: 'Defense to Offense',
                sequences: [
                    ['Sprawl', 'Circle left'],
                    ['Sprawl', 'Circle right'],
                    ['Down block', 'Reshoot'],
                    ['Sprawl', 'Reshoot'],
                    ['Down block', 'Circle left', 'Shoot'],
                    ['Down block', 'Circle right', 'Shoot']
                ]
            },
            chaos: {
                name: 'Mid-Shot Chaos',
                sequences: [
                    ['Fake', 'Sweep single', 'Switch right', 'High crotch'],
                    ['Fake', 'Sweep single', 'Switch left', 'High crotch'],
                    ['Left single', 'Switch right', 'High crotch'],
                    ['Right single', 'Switch left', 'High crotch'],
                    ['Sweep single', 'High crotch', 'Reshoot'],
                    ['Level change', 'Double', 'Reshoot']
                ]
            }
        };

        // Combination definitions - setup → attack → adjust
        const COMBINATIONS = [
            // Setup → Entry
            ['Fake', 'Sweep single'],
            ['Fake', 'Double'],
            ['Fake left', 'Right single'],
            ['Fake right', 'Left single'],
            ['Level change', 'High crotch'],
            ['Circle left', 'Shoot'],
            ['Circle right', 'Shoot'],
            
            // Entry → Transition
            ['Sweep single', 'High crotch'],
            ['High crotch', 'Sweep single'],
            ['Left single', 'Switch right'],
            ['Right single', 'Switch left'],
            ['Double', 'Reshoot'],
            
            // Setup → Entry → Adjust
            ['Fake', 'Sweep single', 'High crotch'],
            ['Fake left', 'Right single', 'Switch left'],
            ['Fake right', 'Left single', 'Switch right'],
            ['Circle', 'Fake', 'Double'],
            
            // Defense → Counter
            ['Down block', 'Reshoot'],
            ['Sprawl', 'Circle left'],
            ['Sprawl', 'Circle right']
        ];

        // Coach phrases by intensity level
        const COACH_PHRASES = {
            motivational: [
                "You're better than this!",
                "Push through it!",
                "Champions don't quit!",
                "Dig deeper!",
                "Move your feet!",
                "You want it or not?",
                "Earn it!",
                "Let's go!",
                "Stay focused!",
                "Keep grinding!"
            ],
            insults: [
                "You call that a sprawl?",
                "No one cares. Work harder.",
                "Faster!",
                "My grandma moves quicker than that!",
                "Is that all you got?",
                "Stop thinking. Just move!",
                "Weak! Again!",
                "That's pathetic!",
                "Where's the intensity?",
                "Soft hands! Tighten up!",
                "Level change! Come on!",
                "Stop being lazy!",
                "Nobody's impressed!",
                "You're moving like molasses!",
                "Pick up the pace!",
                "Sloppy technique!",
                "You're telegraphing everything!",
                "Hands are dead!",
                "Where's your head at?",
                "Focus up!",
                "That was terrible!",
                "Do it right or don't do it!",
                "You're better than this... barely!",
                "Quit dragging your feet!",
                "Show me something!",
                "You're embarrassing yourself!",
                "I've seen better from beginners!",
                "Your technique is garbage!",
                "You're not even trying!",
                "Absolutely pitiful!",
                "You should be ashamed!",
                "This is a waste of time!",
                "You're making excuses with your body!",
                "Completely unacceptable!",
                "You're getting destroyed out there!"
            ],
            crashout: [
                "ARE YOU EVEN TRYING?!",
                "EMBARRASSING!",
                "GET OFF THE MAT!",
                "YOU'RE WASTING MY TIME!",
                "WHAT WAS THAT?!",
                "I'VE SEEN BETTER AT PRACTICE SQUAD!",
                "YOU CALL YOURSELF A WRESTLER?!",
                "PATHETIC! DO IT AGAIN!",
                "MOVE THOSE FEET OR GO HOME!",
                "ZERO EFFORT! ZERO RESULTS!",
                "THIS IS A JOKE!",
                "YOU'RE BETTER THAN THIS... OR ARE YOU?!",
                "UNACCEPTABLE!",
                "WHERE'S THE FIRE?!"
            ]
        };

        // Speed configurations
        const SPEED_CONFIG = {
            slow: { delay: [3500, 4500], jitter: 0.1, playbackRate: 1.1 },
            normal: { delay: [3000, 3500], jitter: 0.1, playbackRate: 1.15 },
            fast: { delay: [1800, 2300], jitter: 0.15, playbackRate: 1.2 },
            chaos: { delay: [700, 1100], jitter: 0.2, playbackRate: 1.3 }
        };

        // State
        let state = {
            running: false,
            speed: 'normal',
            combosEnabled: false,
            mode: 'random', // 'random' or 'course'
            system: 'collar_tie',
            workTime: 60,
            restTime: 20,
            volume: 0.75,
            lastAction: null,
            recentActions: [], // Track last 3 actions to avoid repetition
            coachEnabled: false,
            coachLevel: 0, // 0=off, 1=motivational, 2=insults, 3=crashout
            currentPhase: 'ready', // 'ready', 'work', 'rest'
            timeRemaining: 0,
            courseSequenceIndex: 0,
            speechMultiplier: 1.0,
            delayMultiplier: 1.0,
            showNext: false,
            showReaction: false,
            nextActions: null,
            currentReaction: null,
            selectedVoice: null
        };

        let timers = {
            phase: null,
            callout: null
        };

        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const actionDisplay = document.getElementById('actionDisplay');
        const currentMove = document.getElementById('currentMove');
        const nextMove = document.getElementById('nextMove');
        const timerDisplay = document.getElementById('timer');
        const volumeLights = document.getElementById('volumeLights');
        const speechLights = document.getElementById('speechLights');
        const comboSpeedLights = document.getElementById('comboSpeedLights');
        const coachLights = document.getElementById('coachLights');
        const comboBtn = document.getElementById('comboBtn');
        const showNextBtn = document.getElementById('showNextBtn');
        const showNextBtnCourse = document.getElementById('showNextBtnCourse');
        const showReactionBtn = document.getElementById('showReactionBtn');
        const showReactionBtnRandom = document.getElementById('showReactionBtnRandom');
        const customTiming = document.getElementById('customTiming');
        const courseSelector = document.getElementById('courseSelector');
        const combosGroup = document.getElementById('combosGroup');
        const courseOptionsGroup = document.getElementById('courseOptionsGroup');
        const systemSelect = document.getElementById('systemSelect');
        const systemInfo = document.getElementById('systemInfo');
        const opponentReaction = document.getElementById('opponentReaction');
        const voiceSelect = document.getElementById('voiceSelect');
        
        // Load available voices
        let voices = [];
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = voices.map((voice, i) => 
                `<option value="${i}">${voice.name} (${voice.lang})</option>`
            ).join('');
        }
        
        speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
        
        voiceSelect.addEventListener('change', (e) => {
            state.selectedVoice = voices[parseInt(e.target.value)];
        });
        
        // Initialize volume lights
        function setVolumeLights(level) {
            const lights = volumeLights.querySelectorAll('.light');
            lights.forEach((light, i) => {
                if (i < level) {
                    light.classList.add('active');
                } else {
                    light.classList.remove('active');
                }
            });
            // Amplify volume at max level
            state.volume = level === 8 ? 1.5 : level / 8;
        }
        
        // Initialize speech speed lights (0.9x to 1.2x)
        function setSpeechLights(level) {
            const lights = speechLights.querySelectorAll('.light');
            lights.forEach((light, i) => {
                if (i < level) {
                    light.classList.add('active');
                } else {
                    light.classList.remove('active');
                }
            });
            // Map 1-4 to 0.9-1.2
            state.speechMultiplier = 0.9 + (level - 1) * 0.1;
        }
        
        // Initialize combo speed lights (slower to faster)
        function setComboSpeedLights(level) {
            const lights = comboSpeedLights.querySelectorAll('.light');
            lights.forEach((light, i) => {
                if (i < level) {
                    light.classList.add('active');
                } else {
                    light.classList.remove('active');
                }
            });
            // Map 1-4 to faster combos: higher level = shorter pause
            // Level 1: 100ms, Level 2: 50ms, Level 3: 20ms, Level 4: 0ms
            const pauseTimes = [100, 50, 20, 0];
            state.delayMultiplier = pauseTimes[level - 1];
        }
        
        // Initialize coach intensity lights
        function setCoachLights(level) {
            const lights = coachLights.querySelectorAll('.light');
            lights.forEach((light, i) => {
                if (i <= level) {
                    light.classList.add('active');
                } else {
                    light.classList.remove('active');
                }
            });
            state.coachLevel = level;
        }
        
        // Volume light interaction
        let isDragging = false;
        
        volumeLights.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('light')) {
                isDragging = true;
                const level = parseInt(e.target.dataset.level);
                setVolumeLights(level);
            }
        });
        
        volumeLights.addEventListener('mousemove', (e) => {
            if (isDragging && e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setVolumeLights(level);
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        volumeLights.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setVolumeLights(level);
            }
        });
        
        volumeLights.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('light')) {
                const level = parseInt(element.dataset.level);
                setVolumeLights(level);
            }
        });
        
        // Speech speed light interaction
        let speechDragging = false;
        
        speechLights.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('light')) {
                speechDragging = true;
                const level = parseInt(e.target.dataset.level);
                setSpeechLights(level);
            }
        });
        
        speechLights.addEventListener('mousemove', (e) => {
            if (speechDragging && e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setSpeechLights(level);
            }
        });
        
        speechLights.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setSpeechLights(level);
            }
        });
        
        speechLights.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('light')) {
                const level = parseInt(element.dataset.level);
                setSpeechLights(level);
            }
        });
        
        // Combo speed light interaction
        let comboSpeedDragging = false;
        
        comboSpeedLights.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('light')) {
                comboSpeedDragging = true;
                const level = parseInt(e.target.dataset.level);
                setComboSpeedLights(level);
            }
        });
        
        comboSpeedLights.addEventListener('mousemove', (e) => {
            if (comboSpeedDragging && e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setComboSpeedLights(level);
            }
        });
        
        comboSpeedLights.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setComboSpeedLights(level);
            }
        });
        
        comboSpeedLights.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('light')) {
                const level = parseInt(element.dataset.level);
                setComboSpeedLights(level);
            }
        });
        
        // Coach intensity light interaction
        let coachDragging = false;
        
        coachLights.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('light')) {
                coachDragging = true;
                const level = parseInt(e.target.dataset.level);
                setCoachLights(level);
            }
        });
        
        coachLights.addEventListener('mousemove', (e) => {
            if (coachDragging && e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setCoachLights(level);
            }
        });
        
        coachLights.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('light')) {
                const level = parseInt(e.target.dataset.level);
                setCoachLights(level);
            }
        });
        
        coachLights.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('light')) {
                const level = parseInt(element.dataset.level);
                setCoachLights(level);
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            speechDragging = false;
            comboSpeedDragging = false;
            coachDragging = false;
        });
        
        // Update system info display
        function updateSystemInfo() {
            const sys = SYSTEMS[state.system];
            if (!sys) return;
            
            systemInfo.innerHTML = `
                <h3>Goals</h3>
                <ul>
                    ${sys.high_level_goals.map(g => `<li>${g}</li>`).join('')}
                </ul>
                <h3>Primary Attacks</h3>
                <ul>
                    ${sys.primary_attacks.map(a => `<li>${formatAction(a)}</li>`).join('')}
                </ul>
            `;
        }
        
        function formatAction(action) {
            return action.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }
        
        function showOpponentReaction(reaction) {
            state.currentReaction = formatAction(reaction);
            opponentReaction.textContent = state.currentReaction;
            
            // Remove previous classes
            opponentReaction.classList.remove('show', 'always-show');
            
            if (state.showReaction) {
                opponentReaction.classList.add('always-show');
            } else {
                opponentReaction.classList.add('show');
                setTimeout(() => opponentReaction.classList.remove('show'), 2000);
            }
        }
        
        function showAllOpponentReactions(reactions) {
            if (!reactions || reactions.length === 0) return;
            if (!state.showReaction) return; // Don't show if disabled
            
            const reactionText = 'Opponent: ' + reactions.map(r => formatAction(r)).join(' → ');
            opponentReaction.textContent = reactionText;
            
            // Remove previous classes
            opponentReaction.classList.remove('show', 'always-show');
            opponentReaction.classList.add('always-show');
        }

        // Speech synthesis
        function speak(text, playbackRate = 1.0) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.volume = state.volume;
            utterance.rate = playbackRate;
            utterance.pitch = 1.0;
            if (state.selectedVoice) {
                utterance.voice = state.selectedVoice;
            }
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // Get random delay with jitter
        function getDelay() {
            const config = SPEED_CONFIG[state.speed];
            const base = config.delay[0] + Math.random() * (config.delay[1] - config.delay[0]);
            const jitter = base * config.jitter * (Math.random() * 2 - 1);
            return base + jitter;
        }

        // Select next action
        function selectAction() {
            // Course mode - use system sequences
            if (state.mode === 'course') {
                const sys = SYSTEMS[state.system];
                if (!sys || !sys.sequences) return ['Move'];
                
                const sequences = sys.sequences;
                const seq = sequences[state.courseSequenceIndex % sequences.length];
                state.courseSequenceIndex++;
                
                // Convert sequence steps to action labels, filtering redundant setup moves
                const systemName = state.system.replace(/_/g, ' ');
                const filteredSteps = seq.steps.filter(step => {
                    const action = formatAction(step.action);
                    const lowerAction = action.toLowerCase();
                    // Filter out actions that are just establishing the current tie/system
                    if (systemName.includes('collar') && lowerAction.includes('collar tie')) return false;
                    if (systemName.includes('inside') && lowerAction.includes('inside tie')) return false;
                    if (systemName.includes('two') && lowerAction.includes('two on one')) return false;
                    if (systemName.includes('underhook') && lowerAction.includes('underhook') && !lowerAction.includes('counter')) return false;
                    if (systemName.includes('overhook') && lowerAction.includes('overhook')) return false;
                    return true;
                });
                
                const actions = filteredSteps.map(step => formatAction(step.action));
                
                // If all actions filtered out, return the original
                if (actions.length === 0) {
                    return seq.steps.map(step => formatAction(step.action));
                }
                
                // Show opponent reactions for steps that have them
                const allReactions = [];
                filteredSteps.forEach((step) => {
                    if (step.expect_opponent) {
                        const reactions = step.expect_opponent;
                        const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                        allReactions.push(reaction);
                    }
                });
                
                if (allReactions.length > 0) {
                    setTimeout(() => showAllOpponentReactions(allReactions), 500);
                }
                
                return actions;
            }
            
            // Random mode - use basic moves and combos
            // Occasionally use combination if enabled
            if (state.combosEnabled && Math.random() < 0.4 && COMBOS.length > 0) {
                // Pick random combo
                const combo = COMBOS[Math.floor(Math.random() * COMBOS.length)];
                
                // Get main path actions
                const actions = combo.steps.map(step => formatAction(step.action));
                
                // Show opponent reactions if present
                if (combo.reaction_points && combo.reaction_points.length > 0) {
                    const allReactions = [];
                    combo.reaction_points.forEach(rp => {
                        if (rp.likely_reactions && rp.likely_reactions.length > 0) {
                            const reaction = rp.likely_reactions[Math.floor(Math.random() * rp.likely_reactions.length)];
                            allReactions.push(reaction);
                        }
                    });
                    if (allReactions.length > 0) {
                        setTimeout(() => showAllOpponentReactions(allReactions), 500);
                    }
                }
                
                return actions;
            }
            
            // Select single basic move (avoid repeat)
            if (BASIC_MOVES.length === 0) {
                // Fallback to legacy actions if moves not loaded yet
                const actions = ACTIONS.hard;
                let action;
                let attempts = 0;
                do {
                    action = actions[Math.floor(Math.random() * actions.length)];
                    attempts++;
                } while (state.recentActions.includes(action) && attempts < 20);
                
                state.recentActions.push(action);
                if (state.recentActions.length > 3) state.recentActions.shift();
                state.lastAction = action;
                return [action];
            }
            
            let move;
            let attempts = 0;
            do {
                move = BASIC_MOVES[Math.floor(Math.random() * BASIC_MOVES.length)];
                attempts++;
            } while (state.recentActions.includes(move.label) && attempts < 20);
            
            state.recentActions.push(move.label);
            if (state.recentActions.length > 3) state.recentActions.shift();
            state.lastAction = move.label;
            return [move.label];
        }

        // Call out action with proper speech timing
        function calloutAction() {
            if (!state.running || state.currentPhase !== 'work') return;

            const actions = selectAction();
            const config = SPEED_CONFIG[state.speed];
            
            // Store next actions for preview
            state.nextActions = selectAction();
            
            // Display current move
            currentMove.textContent = actions.join(' → ');
            
            // Display next move if enabled
            if (state.showNext && state.nextActions) {
                nextMove.textContent = 'Next: ' + state.nextActions.join(' → ');
            } else {
                nextMove.textContent = '';
            }
            
            // Randomly add coach phrase based on intensity level
            // Higher levels = more frequent yelling
            let coachProbability = 0;
            if (state.coachLevel === 1) coachProbability = 0.35;
            if (state.coachLevel === 2) coachProbability = 0.40;
            if (state.coachLevel === 3) coachProbability = 0.55;
            
            if (state.coachLevel > 0 && Math.random() < coachProbability) {
                let phraseArray;
                if (state.coachLevel === 1) {
                    phraseArray = COACH_PHRASES.motivational;
                } else if (state.coachLevel === 2) {
                    phraseArray = COACH_PHRASES.insults;
                } else if (state.coachLevel === 3) {
                    phraseArray = COACH_PHRASES.crashout;
                }
                const coachPhrase = phraseArray[Math.floor(Math.random() * phraseArray.length)];
                actions.push(coachPhrase);
            }
            
            // Faster speech for multi-action sequences
            const sequenceRate = actions.length > 1 ? config.playbackRate * 1.15 : config.playbackRate;
            const finalRate = sequenceRate * state.speechMultiplier;
            
            // Speak actions sequentially with proper timing using onend events
            let currentIndex = 0;
            
            function speakNext() {
                if (currentIndex >= actions.length || !state.running || state.currentPhase !== 'work') {
                    // Schedule next callout after sequence completes
                    const baseDelay = getDelay();
                    const extraDelay = actions.length > 1 ? baseDelay * 0.3 : 0;
                    timers.callout = setTimeout(calloutAction, baseDelay + extraDelay);
                    return;
                }
                
                const action = actions[currentIndex];
                const startTime = Date.now();
                console.log(`Speaking: "${action}" at index ${currentIndex}, delay multiplier: ${state.delayMultiplier}ms`);
                
                const utterance = new SpeechSynthesisUtterance(action);
                utterance.volume = state.volume;
                utterance.rate = finalRate;
                utterance.pitch = 1.0;
                utterance.lang = 'en-US';
                if (state.selectedVoice) {
                    utterance.voice = state.selectedVoice;
                }
                
                utterance.onend = () => {
                    const endTime = Date.now();
                    console.log(`Finished speaking in ${endTime - startTime}ms, waiting ${state.delayMultiplier}ms before next`);
                    currentIndex++;
                    if (currentIndex < actions.length) {
                        // Add fluid pause before next move
                        setTimeout(speakNext, state.delayMultiplier);
                    } else {
                        speakNext(); // Trigger next callout
                    }
                };
                
                speechSynthesis.speak(utterance);
            }
            
            speakNext();
        }

        // Start work phase
        function startWork() {
            state.currentPhase = 'work';
            state.timeRemaining = state.workTime;
            currentMove.textContent = 'GO!';
            nextMove.textContent = '';
            speak('Go!', SPEED_CONFIG[state.speed].playbackRate * state.speechMultiplier);
            
            updateTimer();
            timers.callout = setTimeout(calloutAction, getDelay());
            
            timers.phase = setInterval(() => {
                state.timeRemaining--;
                updateTimer();
                
                if (state.timeRemaining <= 0) {
                    clearInterval(timers.phase);
                    clearTimeout(timers.callout);
                    if (state.restTime > 0) {
                        startRest();
                    } else {
                        startWork(); // Continuous mode
                    }
                }
            }, 1000);
        }

        // Start rest phase
        function startRest() {
            state.currentPhase = 'rest';
            state.timeRemaining = state.restTime;
            currentMove.textContent = 'REST';
            nextMove.textContent = '';
            speak('Rest');
            
            updateTimer();
            
            timers.phase = setInterval(() => {
                state.timeRemaining--;
                updateTimer();
                
                if (state.timeRemaining <= 0) {
                    clearInterval(timers.phase);
                    startWork();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimer() {
            const mins = Math.floor(state.timeRemaining / 60);
            const secs = state.timeRemaining % 60;
            timerDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Start session
        function start() {
            state.running = true;
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            startWork();
        }

        // Pause session
        function pause() {
            state.running = false;
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            clearInterval(timers.phase);
            clearTimeout(timers.callout);
            speechSynthesis.cancel();
            currentMove.textContent = 'PAUSED';
            nextMove.textContent = '';
            timerDisplay.textContent = '';
        }

        // Event listeners
        startBtn.addEventListener('click', start);
        pauseBtn.addEventListener('click', pause);

        // Speed buttons
        document.querySelectorAll('[data-speed]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-speed]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.speed = btn.dataset.speed;
            });
        });

        // Timing buttons
        document.querySelectorAll('[data-timing]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-timing]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if (btn.dataset.timing === 'custom') {
                    customTiming.classList.remove('hidden');
                } else {
                    customTiming.classList.add('hidden');
                    const [work, rest] = btn.dataset.timing.split('-').map(Number);
                    state.workTime = work * 60;
                    state.restTime = rest;
                }
            });
        });

        // Custom timing inputs
        document.getElementById('workTime').addEventListener('change', (e) => {
            state.workTime = parseInt(e.target.value) || 60;
        });
        
        document.getElementById('restTime').addEventListener('change', (e) => {
            state.restTime = parseInt(e.target.value) || 30;
        });

        // Combo toggle
        comboBtn.addEventListener('click', () => {
            state.combosEnabled = !state.combosEnabled;
            comboBtn.textContent = `Combos: ${state.combosEnabled ? 'ON' : 'OFF'}`;
            comboBtn.classList.toggle('active');
        });
        
        // Show next toggle
        showNextBtn.addEventListener('click', () => {
            state.showNext = !state.showNext;
            showNextBtn.textContent = `Show Next: ${state.showNext ? 'ON' : 'OFF'}`;
            showNextBtn.classList.toggle('active');
            if (!state.showNext) nextMove.textContent = '';
        });
        
        // Show next toggle (course mode)
        showNextBtnCourse.addEventListener('click', () => {
            state.showNext = !state.showNext;
            showNextBtnCourse.textContent = `Show Next: ${state.showNext ? 'ON' : 'OFF'}`;
            showNextBtnCourse.classList.toggle('active');
            if (!state.showNext) nextMove.textContent = '';
        });
        
        // Show reaction toggle
        showReactionBtn.addEventListener('click', () => {
            state.showReaction = !state.showReaction;
            showReactionBtn.textContent = `Show Reaction: ${state.showReaction ? 'ON' : 'OFF'}`;
            showReactionBtn.classList.toggle('active');
            if (!state.showReaction) {
                opponentReaction.classList.remove('always-show', 'show');
                opponentReaction.textContent = '';
            }
        });
        
        // Show reaction toggle (random mode)
        showReactionBtnRandom.addEventListener('click', () => {
            state.showReaction = !state.showReaction;
            showReactionBtnRandom.textContent = `Show Reaction: ${state.showReaction ? 'ON' : 'OFF'}`;
            showReactionBtnRandom.classList.toggle('active');
            if (!state.showReaction) {
                opponentReaction.classList.remove('always-show', 'show');
                opponentReaction.textContent = '';
            }
        });
        
        // Mode buttons
        document.querySelectorAll('[data-mode]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.mode = btn.dataset.mode;
                
                if (state.mode === 'course') {
                    courseSelector.classList.remove('hidden');
                    combosGroup.classList.add('hidden');
                    courseOptionsGroup.classList.remove('hidden');
                } else {
                    courseSelector.classList.add('hidden');
                    combosGroup.classList.remove('hidden');
                    courseOptionsGroup.classList.add('hidden');
                }
            });
        });
        
        // System select
        systemSelect.addEventListener('change', (e) => {
            state.system = e.target.value;
            state.courseSequenceIndex = 0;
            updateSystemInfo();
        });
        
        // Initialize lights
        setVolumeLights(6);
        setSpeechLights(2); // 1.0x
        setComboSpeedLights(4); // 0ms pause (instant)
        setCoachLights(0); // Off by default
    </script>
</body>
</html>
